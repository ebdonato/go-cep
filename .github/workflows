name: Build and Release Go App

on:
    push:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Go
              uses: actions/setup-go@v2
              with:
                  go-version: 1.20

            - name: Build app for Linux
              run: GOOS=linux GOARCH=amd64 go build -o go-cep-linux
              # Add more files to build for Linux if needed

            - name: Build app for macOS
              run: GOOS=darwin GOARCH=amd64 go build -o go-cep-macos
              # Add more files to build for macOS if needed

            - name: Build app for Windows
              run: GOOS=windows GOARCH=amd64 go build -o go-cep-windows.exe
              # Add more files to build for Windows if needed

            - name: Archive artifacts
              run: |
                  mkdir -p artifacts
                  mv go-cep-linux artifacts/
                  mv go-cep-macos artifacts/
                  mv go-cep-windows.exe artifacts/
              working-directory: ${{ github.workspace }}

            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: v${{ github.run_number }}
                  release_name: Release v${{ github.run_number }}
                  draft: false
                  prerelease: false

            - name: Upload Release Artifacts
              id: upload-release-assets
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./artifacts/
                  asset_name: go-cep-${{ matrix.os }}-${{ matrix.arch }}.${{ github.run_number }}.zip
                  asset_content_type: application/zip
